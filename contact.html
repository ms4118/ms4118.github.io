<!DOCTYPE html>
<html>

<head>
    <!-- Basic -->
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <!-- Mobile Metas -->
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
    <!-- Site Metas -->
    <link rel="icon" href="images/fevicon.png" type="image/gif"/>
    <meta name="keywords" content=""/>
    <meta name="description" content=""/>
    <meta name="author" content=""/>
    <title>Michael GOM</title>

    <!-- bootstrap core css -->
    <link rel="stylesheet" type="text/css" href="css/bootstrap.css"/>
    <!-- fonts style -->
    <link href="https://fonts.googleapis.com/css?family=Poppins:400,600,700&display=swap" rel="stylesheet"/>
    <!-- font awesome style -->
    <link href="css/font-awesome.min.css" rel="stylesheet"/>
    <!-- Custom styles for this template -->
    <link href="css/style.css" rel="stylesheet"/>
    <!-- responsive style -->
    <link href="css/responsive.css" rel="stylesheet"/>
    <!-- for splashscreen -->
    <link href="https://unpkg.com/gridjs/dist/theme/mermaid.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css"/>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script defer src="https://pyscript.net/alpha/pyscript.js"></script>
    <script src="https://unpkg.com/gridjs/dist/gridjs.production.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <style>
        .mytable {
            border-collapse: collapse;
            margin: 20px auto;
        }
        .td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: center;
        }
        .input {
            width: 100%;
            box-sizing: border-box;
        }
        #confirmButtonContainer {
            display: flex;
            justify-content: center; /* 居中对齐 */
            margin-top: 10px;
        }
        #confirmButton {
            padding: 5px 15px; /* 增加按钮的内边距 */
        }
    </style>    
    <py-env>
      - scipy
      - plotly
      - matplotlib
    </py-env>

</head>

<body class="sub_page">
<div class="hero_area">
    <!-- header section strats -->
    <header class="header_section long_section px-0">
        <nav class="navbar navbar-expand-lg custom_nav-container ">
            <a class="navbar-brand" href="index.html">
          <span>
            Michael GOM
          </span>
            </a>
            </a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
                    aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class=""> </span>
            </button>

            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <div class="d-flex mx-auto flex-column flex-lg-row align-items-center">
                    <ul class="navbar-nav  ">
                        <li class="nav-item ">
                            <a class="nav-link" href="index.html">Home <span class="sr-only">(current)</span></a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="about.html"> About</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="furniture.html">Forecasting Logistics</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="blog.html">Inventory Management</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="contact.html">Contact Us</a>
                        </li>
                    </ul>
                </div>
                <div class="quote_btn-container">
                    <a href="">
              <span>
                Project
              </span>
                        <i class="fa fa-user" aria-hidden="true"></i>
                    </a>
                    <form class="form-inline">
                        <button class="btn  my-2 my-sm-0 nav_search-btn" type="submit">
                            <i class="fa fa-search" aria-hidden="true"></i>
                        </button>
                    </form>
                </div>
            </div>
        </nav>
    </header>
    <!-- end header section -->
</div>

<section class="furniture_section layout_padding">
    <div class="container">
        <div class="heading_container">
            <h2>
                Global Operation Management - Forecasting Logistics
            </h2>
            <p>
                This page aims to help you solve problems from Global operation management sector, specifically about
                Forecasting logistics.
            </p>
        </div>

        <div class="row">
          <div class="col-md-12 mx-auto">
            <div class="box">
              <div class="detail-box">
                <h5>
                  Transport problem.
                </h5>
                <div class="">
                    <input type="number" onkeyup="if(this.value<0)this.value=1" onblur="if(this.value<0)this.value=1" id="C" placeholder="num_factories " style="width: 250px;">
                    <input type="number" onkeyup="if(this.value<0)this.value=1" onblur="if(this.value<0)this.value=1" id="D" placeholder="num_stores" style="width: 250px;">
                    <div>
                      <label for="matrix">matrix:</label>
                      <button class="createMatrix" data-col="#D" data-row="#C" data-display="#E" data-title="Matrix" style="margin-left: 26px;">createMatrix</button>
                      <span id="Matrix" style="display: none;"></span>
                    </div>
                    <div>
                      <label for="supplys">supplys:</label>
                      <button class="createMatrix" data-row="#C" data-display="#F" data-title="Supply" style="margin-left: 15px;">createMatrix</button>
                      <span id="Supply" style="display: none;"></span>
                    </div>
                    <div>
                      <label for="demands">demands:</label>
                      <button class="createMatrix" data-row="#D" data-display="#G" data-title="Demand">createMatrix</button>
                      <span id="Demand" style="display: none;"></span>
                    </div>
                    <div id="E" style="display: none;"></div>
                    <div id="F" style="display: none;"></div>
                    <div id="G" style="display: none;"></div>
                    <button id="button_instant">Solve Problem</button>
                    <div id="matrix-dialog" title="Input Matrix" style="display:none;"></div>
                  <py-script>
                    import numpy as np
                    from scipy.optimize import linprog
                    from js import window
                    from pyodide import create_proxy
                    
                    
                    def format_data(matrix, supply, demand, bottom_left_data=''):
                      h = ['']
                      for i in range(len(demand)):
                        h.append(f'Store{i+1}')
                      h.append('supply')
                      index = []
                      for j in range(len(supply)):
                        index.append(f'Factory{j+1}')
                      index.append('demand')
                    
                      result = np.column_stack((matrix, supply))
                      demand = np.append(demand, bottom_left_data)
                      result = np.vstack((result, demand))
                      result = np.column_stack((np.array(index), result))
                    
                      return h, result.tolist()
                    
                    
                    def get_cost_and_total_result(cost_matrix, supply, demand):
                      # 构建决策变量的系数矩阵
                      # 每个工厂到每个商店的运输量可以看作是一个决策变量
                      # 因此，我们有 num_factories * num_stores 个决策变量
                      # 系数矩阵 A 和 b 用于表示供应和需求约束
                      num_factories = len(supply)
                      num_stores = len(demand)
                    
                      # 供应约束的系数矩阵 A_supply 和向量 b_supply
                      A_supply = []
                      for i in range(num_factories):
                        row = [0] * (num_factories * num_stores)
                        for j in range(num_stores):
                          row[i * num_stores + j] = 1
                        A_supply.append(row)
                      A_supply = np.array(A_supply)
                      b_supply = supply
                    
                      # 需求约束的系数矩阵 A_demand 和向量 b_demand
                      A_demand = []
                      for j in range(num_stores):
                        row = [0] * (num_factories * num_stores)
                        for i in range(num_factories):
                          row[i * num_stores + j] = 1
                        A_demand.append(row)
                      A_demand = np.array(A_demand)
                      b_demand = demand
                    
                      # 合并供应和需求约束
                      A = np.vstack((A_supply, -A_demand))  # 注意：需求约束是 >=，所以这里取负号
                      b = np.hstack((b_supply, -b_demand))
                    
                      # 目标函数的系数向量 c
                      c = cost_matrix.flatten()  # 将成本矩阵展平为一维数组
                    
                      # 求解线性规划问题
                      result = linprog(c, A_ub=A, b_ub=b, method='highs')
                    
                      if result.x is not None:
                        # 将结果重新整形为 num_factories x num_stores 的矩阵
                        x = result.x.reshape((num_factories, num_stores))
                      
                        # 输出结果
                        print("Optimal solution:")
                        print(x)
                        print("Optimal value (total cost):", result.fun)
                      
                        return x, result.fun
                      else:
                        return None


                    def on_instant(event):
                      try:
                          n = int(Element("C").element.value)
                          m = int(Element("D").element.value)
                          cost_matrix = [float(i) for i in Element("E").element.innerHTML.split(',')]
                          supply = [float(i) for i in Element("F").element.innerHTML.split(',')]
                          demand = [float(i) for i in Element("G").element.innerHTML.split(',')]
                          if len(cost_matrix) == n*m and len(supply)==n and len(demand)==m:
                            cost_matrix = np.reshape(cost_matrix, (n, m))
                            supply = np.array(supply)
                            demand = np.array(demand)
                            h, d = format_data(cost_matrix, supply, demand, f'{np.sum(demand)}/{np.sum(supply)}')
                            Element("h1").element.style.display = "block"
                            window.setTable(str(h), str(d), "out1")
                            result = get_cost_and_total_result(cost_matrix, supply, demand)
                            if result:
                              x, total_cost = result
                              h, d = format_data(x, supply, demand, f'Total Cost:{total_cost}')
                              Element("h2").element.style.display = "block"
                              window.setTable(str(h), str(d), "out2")

                              Element("out_instant").element.innerHTML = "Calculate successfully."
                            else:
                              Element("out_instant").element.innerHTML = "Calculate error."

                          else:
                            Element("out_instant").element.innerHTML = "Please input real data length."
                      except ValueError:
                          Element("out_instant").element.innerHTML = "Invalid input. Please enter numeric values."
      
                    Element("button_instant").element.onclick = on_instant
                  </py-script>
                  <div id="out_instant"></div>
              </div>
                </div>
              </div>
            </div>
          </div>
        <div class="row">
          <div class="col-md-12">
            <div class="box">
              <h5 id="h1" style="text-align: center;display: none">Original Transportation Cost from factory to store</h5>
              <div id="out1">
              </div>
            </div>
          </div>   
        </div>
        <div class="row">
          <div class="col-md-12">
            <div class="box">
              <h5 id="h2" style="text-align: center;display: none">Optimized Transportation Cost</h5>
              <div class="" id="out2">
              </div>
            </div>
          </div>
        </div>
    </div>
</section>


<!-- footer section -->
<footer class="footer_section">
    <div class="container">
        <p>
            &copy; <span id="displayYear"></span> Michael
            <a href="https://html.design/">2024</a>
        </p>
    </div>
</footer>
<!-- footer section -->

<script>
  $(document).ready(function() {
      $(".createMatrix").click(function() {
          const rowId = $(this).data("row");
          const colId = $(this).data("col");
          const containerId = $(this).data("display");
          const title = $(this).data("title");

          const dataContainer = $(containerId)

          const rows = parseInt($(rowId).val());
          let cols = 1
          if (colId !== undefined) {
            cols = parseInt($(colId).val());
          }

          if (dataContainer.data('matrix') && dataContainer.data('matrix').split(',').length !== rows*cols) {
            dataContainer.html('');
            dataContainer.data('matrix', ''); // 保存矩阵数据
          }

          const dialog = $("#matrix-dialog");
          // 清空之前的内容
          dialog.html('');

          // 创建表格
          const table = $("<table class='mytable'></table>");
          if (title === 'Matrix') {
            const thead = $("<thead></thead>");
            const headerRow = $("<tr class='tr'></tr>");

            // 添加索引列标题
            headerRow.append($("<th class='td'></th>").text(""));

            // 添加列标题
            for (let j = 0; j < cols; j++) {
                const th = $("<th class='td'></th>").text("Factory" + (j + 1));
                headerRow.append(th);
            }
            thead.append(headerRow);
            table.append(thead);
          }

          // 添加表格主体
          const tbody = $("<tbody></tbody>");
          for (let i = 0; i < rows; i++) {
              const tr = $("<tr class='tr'></tr>");
              
              // 添加索引单元格
              if(title === 'Matrix') {
                const indexTd = $("<td class='td'></td>").text('Store' + (i + 1)); // 索引从1开始
                tr.append(indexTd);
              }
              
              for (let j = 0; j < cols; j++) {
                  const td = $("<td class='td'></td>");
                  let input = $("<input class='input' type='text'>");
                  if (title !== 'Matrix') {
                    input = $("<input class='input' type='text' placeholder='" + title  + (i+1) + "'>");
                  }
                  const index = cols > 1 ? i*cols+j : i;
                  // 如果有已提交的矩阵，读取对应的值
                  const existingValue = dataContainer.data('matrix') && dataContainer.data('matrix').split(',')[index];
                  if (existingValue) {
                      input.val(existingValue);
                  }
                  
                  td.append(input);
                  tr.append(td);
              }
              tbody.append(tr);
          }
          table.append(tbody);

          // 添加表格到对话框
          dialog.append(table);

          // 添加确认按钮
          const confirmButtonContainer = $("<div id='confirmButtonContainer'></div>");
          const confirmButton = $("<button id='confirmButton'>Confirm</button>");
          confirmButtonContainer.append(confirmButton);
          dialog.append(confirmButtonContainer);

          // 显示对话框
          const separate = cols < 10 ? 20 : 30
          const width = cols > 5 && title === 'Matrix' ?  800+cols*20 : 800
          console.log(width)
          dialog.dialog({
              modal: true,
              width: width,
              title: title + " Input",
              close: function() {
                  dialog.html(""); // 清空内容
              },
              create: function(event, ui) {
                // 对话框打开时执行的代码
                replaceCloseButton();
              }
          });

          // 确认按钮点击事件
          confirmButton.click(function() {
              const results = [];
              let isValid = true; // 标记是否所有单元格都有效

              dialog.find("input").each(function() {
                  const value = $(this).val();
                  results.push(value);
                  if (value.trim() === "") { // 检查是否为空
                      isValid = false;
                  }
              });

              if (!isValid) {
                dialog.dialog("close"); // 清空内容
                alert("All cells must input value！"); // 提示用户
              } else {
                  // 将结果添加到已提交的矩阵区域
                  const matrixData = results.join(", ")
                  
                  // 显示提交的矩阵
                  dataContainer.html(matrixData);
                  dataContainer.data('matrix', matrixData); // 保存矩阵数据

                  console.log("输入的结果:", results);
                  const displayData = results.reduce((acc, val, index) => {
                        const rowIndex = Math.floor(index / cols);
                        if (!acc[rowIndex]) acc[rowIndex] = [];
                        acc[rowIndex].push(val);
                        return acc;
                  }, []);
                  $("#"+title).html(JSON.stringify(displayData));
                  $("#"+title).show();
                  dialog.dialog("close"); // 清空内容
              }
          });
      });
  });
  function replaceCloseButton() {
    console.log("hello");
    // 查找对话框标题栏中的关闭按钮
    var closeButton = $(".ui-dialog-titlebar-close", $("#dialog").parent()); // 注意：使用父容器来确保找到正确的关闭按钮

    // 如果找到了关闭按钮，则进行替换
    if (closeButton.length > 0) {
        // 创建新的按钮元素及其子元素（第二部分代码的结构）
        var newButton = $('<button></button>')
            .attr('type', 'button')
            .addClass('ui-button ui-corner-all ui-widget ui-button-icon-only ui-dialog-titlebar-close')
            .attr('title', 'Close');

        var iconSpan = $('<span></span>')
            .addClass('ui-button-icon ui-icon ui-icon-closethick');

        var textSpan = $('<span></span>')
            .text('Close'); // 注意：这里可以根据需要添加文本或省略

        // 如果不需要文本，则不添加 textSpan 到 newButton 中
        // newButton.append(textSpan);

        // 将图标添加到新按钮中（通常图标就足够了，不需要文本）
        newButton.append(iconSpan);

        // 由于 jQuery UI 的对话框可能会自动处理关闭按钮的事件，
        // 你可能需要重新绑定关闭事件到新按钮上（如果需要的话）。
        // 但是，在这个例子中，我们假设 jQuery UI 会处理它。

        // 替换旧的关闭按钮
        closeButton.replaceWith(newButton);

        // 注意：如果 jQuery UI 在后续操作中重新创建了关闭按钮，
        // 你可能需要在其他地方（如对话框的 'create' 或 'focus' 事件中）再次执行替换逻辑。
    }
  }
  function str2Aarry(str) {
    str = str.slice(1, -1); // 使用 slice 方法去除第一个和最后一个字符（即方括号）
 
    // 步骤2: 使用 split 方法按逗号分割字符串
    // 注意：这里我们得到一个包含字符串元素的数组，可能还需要进一步处理
    let arr = str.split(',').map(item => {
        // 去除元素两侧的空格（如果有的话）
        item = item.trim();
        item = item.replace(/^'|'$/g, '');
        
        return item;
    });

    return arr
  }
  function str2Aarry2D(str) {
    // 第一步：去除最外层的方括号
    str = str.slice(1, -1);
    
    // 第二步：按外部逗号分割字符串以获取内部数组的字符串表示
    let innerArrayStrs = str.split('], [');
    
    // 第三步：将每个内部数组的字符串表示转换为真正的数组
    let twoDArray = innerArrayStrs.map(str2Aarry)

    return twoDArray
  }
  function setTable(headers, data, renderId) {
    console.log(headers)
    console.log(data)
    const grid = new gridjs.Grid({
        columns: str2Aarry(headers),
        data: str2Aarry2D(data)
      })
    // 获取容器元素
    const container = document.getElementById(renderId);
    // 清空容器元素（虽然在这个例子中它应该是空的，但这是一个好习惯）
    container.innerHTML = '';
    // 渲染 Grid.js 表格
    grid.render(container);
  }
</script>
<!-- bootstrap js -->
<script src="js/bootstrap.js"></script>
<!-- custom js -->
<script src="js/custom.js"></script>
<!-- Google Map -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCh39n5U-4IoWpsVGUHWdqB6puEkhRLdmI&callback=myMap"></script>
<!-- End Google Map -->

</body>

</html>
